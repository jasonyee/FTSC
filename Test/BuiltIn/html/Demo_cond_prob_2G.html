
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Test for Conditional Probability using VSS, unshuffled</title><meta name="generator" content="MATLAB 9.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-08-08"><meta name="DC.source" content="Demo_cond_prob_2G.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Test for Conditional Probability using VSS, unshuffled</h1><!--introduction--><pre>Adding the following folders to the path:
 -FTSC</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Clear</a></li><li><a href="#2">Simulation: Group 1</a></li><li><a href="#3">Simulation: Group 2</a></li><li><a href="#4">Model setting</a></li><li><a href="#5">group 1</a></li><li><a href="#6">group 2</a></li><li><a href="#8">Shuffle data</a></li><li><a href="#9">Fitting SSM model</a></li><li><a href="#10">logCondProb for subjects from group 1</a></li><li><a href="#11">logCondProb for subjects from group 2</a></li><li><a href="#12">posterior probability</a></li><li><a href="#13">Group 1 state space model</a></li><li><a href="#14">Group 2 state space model</a></li><li><a href="#15">group average</a></li><li><a href="#16">Misclassified subject</a></li><li><a href="#17">subject-fit of misclassified subject : group 1</a></li><li><a href="#18">subject-fit of misclassified subject : group 2</a></li><li><a href="#19">plot the subject-fit of the misclassified subject</a></li></ul></div><h2>Clear<a name="1"></a></h2><pre class="codeinput">clear;
clc;
rng(1)                                       <span class="comment">% control the randomness</span>

nClusters = 2;

m = 30;                                       <span class="comment">% number of observations</span>
t = (1:m)/m;
p = 1;                                        <span class="comment">% # of fixed effects</span>
q = 1;                                        <span class="comment">% # of random effects</span>
</pre><h2>Simulation: Group 1<a name="2"></a></h2><pre class="codeinput">n1 = 20;                                      <span class="comment">% number of subjects</span>
sigma_e = 1;                                  <span class="comment">% variance of white noise</span>
realFixedEffect1 = 5 * sin(2*pi*t);             <span class="comment">% p-by-m</span>
realRandomEffect1 = randn(n1,4)*[cos(2*pi*t);cos(4*pi*t);<span class="keyword">...</span>
                               cos(6*pi*t);ones(1,m)];

realY1 = repmat(realFixedEffect1, [n1,1]) + realRandomEffect1;

Y1 = realY1+ sqrt(sigma_e)*randn(n1,m);
</pre><h2>Simulation: Group 2<a name="3"></a></h2><pre class="codeinput">n2 = 20;                                      <span class="comment">% number of subjects</span>
sigma_e = 1;                                  <span class="comment">% variance of white noise</span>

realFixedEffect2 = 7 * sin(2*pi*t + pi/4);              <span class="comment">% p-by-m</span>
realRandomEffect2 = randn(n2,4)*[cos(2*pi*t);cos(4*pi*t);<span class="keyword">...</span>
                               cos(6*pi*t);ones(1,m)];

realY2 = repmat(realFixedEffect2, [n2,1]) + realRandomEffect2;

Y2 = realY2+ sqrt(sigma_e)*randn(n2,m);
</pre><h2>Model setting<a name="4"></a></h2><pre class="codeinput">fixedArray = ones(1,p);
randomArray = ones(1,q);

<span class="comment">% Start point</span>
logpara0 = [0;                                    <span class="comment">% log of e</span>
         -10;-10;                                 <span class="comment">% logs of lambdaF, lambdaR</span>
         1;1];                          <span class="comment">% log of randomDiag</span>

diffusePrior = 1e7;

dataset = [Y1; Y2];
prior = ones(1, nClusters)/nClusters;

logparahat = zeros(length(logpara0), nClusters);
fval = zeros(1, nClusters);
</pre><h2>group 1<a name="5"></a></h2><pre class="codeinput">[logparahat(:,1), fval(1)] = <span class="keyword">...</span>
        fmeTraining(@BuiltIn, Y1, fixedArray, randomArray, t, logpara0, diffusePrior);
</pre><h2>group 2<a name="6"></a></h2><pre class="codeinput">[logparahat(:,2), fval(2)] = <span class="keyword">...</span>
        fmeTraining(@BuiltIn, Y2, fixedArray, randomArray, t, logpara0, diffusePrior);
</pre><pre class="codeinput">logCondProb0 = - fval
logparahat
</pre><pre class="codeoutput">
logCondProb0 =

   1.0e+03 *

   -1.1514   -1.1652


logparahat =

    0.1004   -0.0011
  -11.1655  -13.8890
   -8.4670   -9.0895
    0.9224   -1.0151
   -8.4737   -4.2620

</pre><h2>Shuffle data<a name="8"></a></h2><p>Y1 = Y1(randperm(size(Y1,1)),:); Y2 = Y2(randperm(size(Y2,1)),:);</p><h2>Fitting SSM model<a name="9"></a></h2><p>group 1</p><pre class="codeinput">SSMp1(1) = fme2ss(n1+1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);
SSMm1(1) = fme2ss(n1-1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);

<span class="comment">% group 2</span>
SSMp1(2) = fme2ss(n2+1, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);
SSMm1(2) = fme2ss(n2-1, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);

Algo = @BuiltIn;
Switches = 0;
logCondProb = zeros(n1+n2, nClusters);
</pre><h2>logCondProb for subjects from group 1<a name="10"></a></h2><pre class="codeinput">correct_G1 = 0;
<span class="keyword">for</span> i=1:n1
    <span class="comment">% compute the logcondprob for cluster 1</span>
    Members1 = 1:n1;
    Members1(Members1 == i) = [];
    logCondProb(i,1) = logCondProb0(1) - Algo(SSMm1(1), Y1(Members1,:));

    <span class="comment">% compute the logcondprob for cluster 2</span>
    logCondProb(i,2) = Algo(SSMp1(2), [Y2; Y1(i,:)]) - logCondProb0(2);

    <span class="keyword">if</span> logCondProb(i,1) &gt; logCondProb(i,2)
        correct_G1 = correct_G1 + 1;
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>logCondProb for subjects from group 2<a name="11"></a></h2><pre class="codeinput">correct_G2 = 0;
<span class="keyword">for</span> j=1:n2
    <span class="comment">% compute the logcondprob for cluster 1</span>
    logCondProb(n1+j,1) = Algo(SSMp1(1), [Y1; Y2(j,:)]) - logCondProb0(1);

    <span class="comment">% compute the logcondprob for cluster 2</span>
    Members2 = 1:n2;
    Members2(Members2 == j) = [];
    logCondProb(n1+j,2) = logCondProb0(2) - Algo(SSMm1(2), Y2(Members2,:));

    <span class="keyword">if</span> logCondProb(n1+j,1) &lt; logCondProb(n1+j,2)
        correct_G2 = correct_G2 + 1;
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>posterior probability<a name="12"></a></h2><pre class="codeinput">Priors = repmat(prior, n1+n2, 1);
CondProbs = exp(logCondProb);
Posteriors = BayesUpdate(Priors, CondProbs);

<span class="comment">% get variable names</span>
VarNames = repmat({}, 1, nClusters);
<span class="keyword">for</span> k=1:nClusters
    VarNames{k} = strcat(<span class="string">'Group '</span>, num2str(k));
<span class="keyword">end</span>

<span class="comment">% get row names</span>
RowNames = repmat({}, n1+n2, 1);
<span class="keyword">for</span> i=1:n1+n2
    RowNames{i} = strcat(<span class="string">'Subject '</span>, num2str(i));
<span class="keyword">end</span>

PosteriorsTable = <span class="keyword">...</span>
    array2table(round(Posteriors,4), <span class="string">'VariableNames'</span>, VarNames, <span class="string">'RowNames'</span>, RowNames)

SensTable = array2table([correct_G1, n1 - correct_G1; n2 - correct_G2, correct_G2],<span class="keyword">...</span>
    <span class="string">'VariableNames'</span>, {<span class="string">'Cluster1'</span>, <span class="string">'Cluster2'</span>}, <span class="string">'RowNames'</span>, {<span class="string">'Group1'</span>, <span class="string">'Group2'</span>})
</pre><pre class="codeoutput">
PosteriorsTable = 

                 Group1    Group2
                 ______    ______

    Subject1          1         0
    Subject2          1         0
    Subject3     0.9793    0.0207
    Subject4     0.9995    0.0005
    Subject5          1         0
    Subject6          1         0
    Subject7          1         0
    Subject8     0.9354    0.0646
    Subject9          1         0
    Subject10         1         0
    Subject11    0.9998    0.0002
    Subject12     0.998     0.002
    Subject13         1         0
    Subject14         1         0
    Subject15         1         0
    Subject16    0.9995    0.0005
    Subject17         1         0
    Subject18      0.99      0.01
    Subject19     0.997     0.003
    Subject20    0.6416    0.3584
    Subject21    0.1641    0.8359
    Subject22    0.0004    0.9996
    Subject23    0.0044    0.9956
    Subject24    0.3366    0.6634
    Subject25    0.0183    0.9817
    Subject26    0.0042    0.9958
    Subject27    0.0107    0.9893
    Subject28    0.1324    0.8676
    Subject29    0.0008    0.9992
    Subject30    0.0052    0.9948
    Subject31    0.1208    0.8792
    Subject32    0.0002    0.9998
    Subject33    0.0054    0.9946
    Subject34    0.0121    0.9879
    Subject35    0.0354    0.9646
    Subject36    0.2505    0.7495
    Subject37      0.27      0.73
    Subject38    0.1507    0.8493
    Subject39    0.0043    0.9957
    Subject40    0.0148    0.9852


SensTable = 

              Cluster1    Cluster2
              ________    ________

    Group1    20           0      
    Group2     0          20      

</pre><h2>Group 1 state space model<a name="13"></a></h2><pre class="codeinput">SSM_G1 = fme2ss(n1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);
[logL_G1, Output_G1] = BuiltInSmoother(SSM_G1, Y1);
</pre><h2>Group 2 state space model<a name="14"></a></h2><pre class="codeinput">SSM_G2 = fme2ss(n2, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);
[logL_G2, Output_G2] = BuiltInSmoother(SSM_G2, Y2);
</pre><h2>group average<a name="15"></a></h2><pre class="codeinput">k = 1; <span class="comment">% the real fixed effect state parameter</span>
ConfidenceLevel = 0.95; <span class="comment">% confidence level</span>
<span class="comment">% group 1</span>
[Smoothed_G1, SmoothedVar_G1] =<span class="keyword">...</span>
StatesMeanVar(Output_G1, <span class="string">'built-in'</span>, <span class="string">'smooth'</span>);
[Smoothed95Upper_G1, Smoothed95Lower_G1] = <span class="keyword">...</span>
NormalCI(Smoothed_G1, SmoothedVar_G1, ConfidenceLevel);
<span class="comment">% group 2</span>
[Smoothed_G2, SmoothedVar_G2] =<span class="keyword">...</span>
StatesMeanVar(Output_G2, <span class="string">'built-in'</span>, <span class="string">'smooth'</span>);
[Smoothed95Upper_G2, Smoothed95Lower_G2] = <span class="keyword">...</span>
NormalCI(Smoothed_G2, SmoothedVar_G2, ConfidenceLevel);
</pre><h2>Misclassified subject<a name="16"></a></h2><pre class="codeinput">r = 20;
figure;
plot(t, Y1(r,:),<span class="keyword">...</span>
t, Smoothed_G1(k,:),<span class="keyword">...</span>
t, Smoothed_G2(k,:),<span class="keyword">...</span>
t, Smoothed95Upper_G1(k,:), <span class="string">'--'</span>,<span class="keyword">...</span>
t, Smoothed95Lower_G1(k,:), <span class="string">'--'</span>,<span class="keyword">...</span>
t, Smoothed95Upper_G2(k,:), <span class="string">':'</span>,<span class="keyword">...</span>
t, Smoothed95Lower_G2(k,:), <span class="string">':'</span>);
legend(<span class="string">'raw'</span>, <span class="string">'group 1'</span>, <span class="string">'group 2'</span>);
title(strcat(<span class="string">'misclassified subhject, n='</span>, num2str(r)));
</pre><img vspace="5" hspace="5" src="Demo_cond_prob_2G_01.png" alt=""> <h2>subject-fit of misclassified subject : group 1<a name="17"></a></h2><pre class="codeinput">[yFittedMean_G1, yFittedVar_G1] = SpaceMeanVar(Output_G1, SSM_G1, <span class="string">'built-in'</span>, <span class="string">'smooth'</span>);

[yFitted95Upper_G1, yFitted95Lower_G1] = <span class="keyword">...</span>
NormalCI(yFittedMean_G1, yFittedVar_G1, ConfidenceLevel);
</pre><h2>subject-fit of misclassified subject : group 2<a name="18"></a></h2><pre class="codeinput">[logL_G2p1, Output_G2p1] = BuiltInSmoother(SSMp1(2), [Y2; Y1(r,:)]);

[yFittedMean_G2, yFittedVar_G2] = SpaceMeanVar(Output_G2p1, SSMp1(2), <span class="string">'built-in'</span>, <span class="string">'smooth'</span>);

[yFitted95Upper_G2, yFitted95Lower_G2] = <span class="keyword">...</span>
NormalCI(yFittedMean_G2, yFittedVar_G2, ConfidenceLevel);
</pre><h2>plot the subject-fit of the misclassified subject<a name="19"></a></h2><pre class="codeinput">figure;
plot(t, Y1(r,:),<span class="keyword">...</span>
t, yFittedMean_G1(r,:),<span class="keyword">...</span>
t, yFittedMean_G2(end,:),<span class="keyword">...</span>
t, yFitted95Upper_G1(r,:), <span class="string">'--'</span>,<span class="keyword">...</span>
t, yFitted95Lower_G1(r,:), <span class="string">'--'</span>,<span class="keyword">...</span>
t, yFitted95Upper_G2(end,:), <span class="string">':'</span>,<span class="keyword">...</span>
t, yFitted95Lower_G2(end,:), <span class="string">':'</span>);
legend(<span class="string">'raw'</span>, <span class="string">'group 1 fit with --'</span>, <span class="string">'group 2 fit with :'</span>);
title(strcat(<span class="string">'misclassified subject, n='</span>, num2str(r)));
</pre><img vspace="5" hspace="5" src="Demo_cond_prob_2G_02.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Test for Conditional Probability using VSS, unshuffled
%  Adding the following folders to the path:
%   -FTSC

%% Clear
clear;
clc;
rng(1)                                       % control the randomness

nClusters = 2;

m = 30;                                       % number of observations
t = (1:m)/m;
p = 1;                                        % # of fixed effects
q = 1;                                        % # of random effects

%% Simulation: Group 1
n1 = 20;                                      % number of subjects
sigma_e = 1;                                  % variance of white noise
realFixedEffect1 = 5 * sin(2*pi*t);             % p-by-m
realRandomEffect1 = randn(n1,4)*[cos(2*pi*t);cos(4*pi*t);...
                               cos(6*pi*t);ones(1,m)];
                 
realY1 = repmat(realFixedEffect1, [n1,1]) + realRandomEffect1;

Y1 = realY1+ sqrt(sigma_e)*randn(n1,m);



%% Simulation: Group 2
n2 = 20;                                      % number of subjects
sigma_e = 1;                                  % variance of white noise

realFixedEffect2 = 7 * sin(2*pi*t + pi/4);              % p-by-m
realRandomEffect2 = randn(n2,4)*[cos(2*pi*t);cos(4*pi*t);...
                               cos(6*pi*t);ones(1,m)];
                 
realY2 = repmat(realFixedEffect2, [n2,1]) + realRandomEffect2;

Y2 = realY2+ sqrt(sigma_e)*randn(n2,m);


%% Model setting

fixedArray = ones(1,p);
randomArray = ones(1,q);

% Start point
logpara0 = [0;                                    % log of e  
         -10;-10;                                 % logs of lambdaF, lambdaR
         1;1];                          % log of randomDiag

diffusePrior = 1e7;

dataset = [Y1; Y2];
prior = ones(1, nClusters)/nClusters;

logparahat = zeros(length(logpara0), nClusters);
fval = zeros(1, nClusters);

%% group 1
[logparahat(:,1), fval(1)] = ...
        fmeTraining(@BuiltIn, Y1, fixedArray, randomArray, t, logpara0, diffusePrior);

%% group 2
[logparahat(:,2), fval(2)] = ...
        fmeTraining(@BuiltIn, Y2, fixedArray, randomArray, t, logpara0, diffusePrior); 
%%    
logCondProb0 = - fval
logparahat
%% Shuffle data
% Y1 = Y1(randperm(size(Y1,1)),:);
% Y2 = Y2(randperm(size(Y2,1)),:);

%% Fitting SSM model
% group 1
SSMp1(1) = fme2ss(n1+1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);
SSMm1(1) = fme2ss(n1-1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);

% group 2
SSMp1(2) = fme2ss(n2+1, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);
SSMm1(2) = fme2ss(n2-1, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);

Algo = @BuiltIn;
Switches = 0;
logCondProb = zeros(n1+n2, nClusters);


%% logCondProb for subjects from group 1
correct_G1 = 0;
for i=1:n1
    % compute the logcondprob for cluster 1
    Members1 = 1:n1;
    Members1(Members1 == i) = [];
    logCondProb(i,1) = logCondProb0(1) - Algo(SSMm1(1), Y1(Members1,:));
    
    % compute the logcondprob for cluster 2
    logCondProb(i,2) = Algo(SSMp1(2), [Y2; Y1(i,:)]) - logCondProb0(2);
    
    if logCondProb(i,1) > logCondProb(i,2)
        correct_G1 = correct_G1 + 1;
    end
end

%% logCondProb for subjects from group 2
correct_G2 = 0;
for j=1:n2
    % compute the logcondprob for cluster 1
    logCondProb(n1+j,1) = Algo(SSMp1(1), [Y1; Y2(j,:)]) - logCondProb0(1);
    
    % compute the logcondprob for cluster 2
    Members2 = 1:n2;
    Members2(Members2 == j) = [];
    logCondProb(n1+j,2) = logCondProb0(2) - Algo(SSMm1(2), Y2(Members2,:));
    
    if logCondProb(n1+j,1) < logCondProb(n1+j,2)
        correct_G2 = correct_G2 + 1;
    end
end


%% posterior probability
Priors = repmat(prior, n1+n2, 1);
CondProbs = exp(logCondProb);
Posteriors = BayesUpdate(Priors, CondProbs);
    
% get variable names
VarNames = repmat({}, 1, nClusters);
for k=1:nClusters
    VarNames{k} = strcat('Group ', num2str(k));
end

% get row names
RowNames = repmat({}, n1+n2, 1);
for i=1:n1+n2
    RowNames{i} = strcat('Subject ', num2str(i));
end

PosteriorsTable = ...
    array2table(round(Posteriors,4), 'VariableNames', VarNames, 'RowNames', RowNames)

SensTable = array2table([correct_G1, n1 - correct_G1; n2 - correct_G2, correct_G2],...
    'VariableNames', {'Cluster1', 'Cluster2'}, 'RowNames', {'Group1', 'Group2'})

%% Group 1 state space model
SSM_G1 = fme2ss(n1, fixedArray, randomArray, t, logparahat(:,1), diffusePrior);
[logL_G1, Output_G1] = BuiltInSmoother(SSM_G1, Y1);

%% Group 2 state space model
SSM_G2 = fme2ss(n2, fixedArray, randomArray, t, logparahat(:,2), diffusePrior);
[logL_G2, Output_G2] = BuiltInSmoother(SSM_G2, Y2);

%% group average
k = 1; % the real fixed effect state parameter
ConfidenceLevel = 0.95; % confidence level
% group 1
[Smoothed_G1, SmoothedVar_G1] =...
StatesMeanVar(Output_G1, 'built-in', 'smooth');
[Smoothed95Upper_G1, Smoothed95Lower_G1] = ...
NormalCI(Smoothed_G1, SmoothedVar_G1, ConfidenceLevel);
% group 2
[Smoothed_G2, SmoothedVar_G2] =...
StatesMeanVar(Output_G2, 'built-in', 'smooth');
[Smoothed95Upper_G2, Smoothed95Lower_G2] = ...
NormalCI(Smoothed_G2, SmoothedVar_G2, ConfidenceLevel);



%% Misclassified subject
r = 20;
figure;
plot(t, Y1(r,:),...
t, Smoothed_G1(k,:),...
t, Smoothed_G2(k,:),...
t, Smoothed95Upper_G1(k,:), 'REPLACE_WITH_DASH_DASH',...
t, Smoothed95Lower_G1(k,:), 'REPLACE_WITH_DASH_DASH',...
t, Smoothed95Upper_G2(k,:), ':',...
t, Smoothed95Lower_G2(k,:), ':');
legend('raw', 'group 1', 'group 2');
title(strcat('misclassified subhject, n=', num2str(r)));

%% subject-fit of misclassified subject : group 1

[yFittedMean_G1, yFittedVar_G1] = SpaceMeanVar(Output_G1, SSM_G1, 'built-in', 'smooth');

[yFitted95Upper_G1, yFitted95Lower_G1] = ...
NormalCI(yFittedMean_G1, yFittedVar_G1, ConfidenceLevel);

%% subject-fit of misclassified subject : group 2

[logL_G2p1, Output_G2p1] = BuiltInSmoother(SSMp1(2), [Y2; Y1(r,:)]);

[yFittedMean_G2, yFittedVar_G2] = SpaceMeanVar(Output_G2p1, SSMp1(2), 'built-in', 'smooth');

[yFitted95Upper_G2, yFitted95Lower_G2] = ...
NormalCI(yFittedMean_G2, yFittedVar_G2, ConfidenceLevel);

%% plot the subject-fit of the misclassified subject

figure;
plot(t, Y1(r,:),...
t, yFittedMean_G1(r,:),...
t, yFittedMean_G2(end,:),...
t, yFitted95Upper_G1(r,:), 'REPLACE_WITH_DASH_DASH',...
t, yFitted95Lower_G1(r,:), 'REPLACE_WITH_DASH_DASH',...
t, yFitted95Upper_G2(end,:), ':',...
t, yFitted95Lower_G2(end,:), ':');
legend('raw', 'group 1 fit with REPLACE_WITH_DASH_DASH', 'group 2 fit with :');
title(strcat('misclassified subject, n=', num2str(r)));








##### SOURCE END #####
--></body></html>